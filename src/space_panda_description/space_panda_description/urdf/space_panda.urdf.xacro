<?xml version="1.0"?>
<robot name="space_panda" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- ✅ ROS 2 SAFE INCLUDE -->
  <xacro:include filename="$(find franka_description)/robots/common/franka_robot.xacro"/>

  <xacro:property name="load_gripper" value="true"/>
  <xacro:property name="ee_id" value="franka_hand"/>

  <!-- ================= SATELLITE BASE (ROOT LINK) ================= -->
  <!-- No world link needed - satellite_base is the root, allowing free motion in space -->
  <link name="satellite_base">

    <visual>
      <geometry>
        <mesh
          filename="$(find space_panda_description)/meshes/cubesat.stl"
          scale="0.5 0.5 0.5"/>
      </geometry>
      <material name="satellite_grey">
        <color rgba="0.6 0.6 0.6 1.0"/>
      </material>
    </visual>

    <!-- ✅ SIMPLE collision for stable physics -->
    <collision>
      <geometry>
        <!-- 1.5m box to match roughly with the visual scale and arm mounting height -->
        <box size="1.5 1.5 1.5"/>
      </geometry>
      <!-- Center the collision box -->
      <origin xyz="0 0 0"/>
    </collision>

    <inertial>
      <mass value="500.0"/>
      <origin xyz="0 0 0"/>
      <inertia
        ixx="20" ixy="0" ixz="0"
        iyy="20" iyz="0"
        izz="20"/>
    </inertial>

  </link>

  <!-- Satellite is dynamic (can move freely in space) -->
  <gazebo reference="satellite_base">
    <static>false</static>
  </gazebo>

  <!-- ================= PAN-TILT CAMERA SYSTEM ================= -->
  
  <!-- Camera Base (for azimuth rotation) -->
  <link name="camera_base">
    <inertial>
      <mass value="0.1"/>
      <origin xyz="0 0 0"/>
      <inertia
        ixx="0.001" ixy="0" ixz="0"
        iyy="0.001" iyz="0"
        izz="0.001"/>
    </inertial>
    <visual>
      <geometry>
        <cylinder radius="0.05" length="0.1"/>
      </geometry>
      <material name="camera_mount">
        <color rgba="0.3 0.3 0.3 1.0"/>
      </material>
    </visual>
  </link>

  <!-- Joint: Satellite → Camera Base (Azimuth/Horizontal rotation) -->
  <joint name="camera_azimuth_joint" type="revolute">
    <parent link="satellite_base"/>
    <child link="camera_base"/>
    <origin xyz="0 0 1.0" rpy="0 0 0"/>  <!-- Mount on top of satellite -->
    <axis xyz="0 0 1"/>  <!-- Rotate around Z axis (horizontal spin) -->
    <limit lower="-6.28319" upper="6.28319" effort="10" velocity="1.0"/>  <!-- 360° rotation -->
  </joint>

  <!-- Camera Tilt Mount (for elevation) -->
  <link name="camera_tilt">
    <inertial>
      <mass value="0.05"/>
      <origin xyz="0 0 0"/>
      <inertia
        ixx="0.0005" ixy="0" ixz="0"
        iyy="0.0005" iyz="0"
        izz="0.0005"/>
    </inertial>
    <visual>
      <geometry>
        <box size="0.08 0.05 0.05"/>
      </geometry>
      <material name="camera_tilt">
        <color rgba="0.2 0.2 0.2 1.0"/>
      </material>
    </visual>
  </link>

  <!-- Joint: Camera Base → Camera Tilt (Elevation/Vertical tilt) -->
  <joint name="camera_elevation_joint" type="revolute">
    <parent link="camera_base"/>
    <child link="camera_tilt"/>
    <origin xyz="0 0 0.05" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>  <!-- Rotate around Y axis (tilt up/down) -->
    <limit lower="-3.14159" upper="3.14159" effort="10" velocity="1.0"/>  <!-- 180° up/down -->
  </joint>

  <!-- Camera Link (actual camera sensor) -->
  <link name="camera_link">
    <inertial>
      <mass value="0.02"/>
      <origin xyz="0 0 0"/>
      <inertia
        ixx="0.0001" ixy="0" ixz="0"
        iyy="0.0001" iyz="0"
        izz="0.0001"/>
    </inertial>
    <visual>
      <geometry>
        <box size="0.03 0.06 0.03"/>
      </geometry>
      <material name="camera_body">
        <color rgba="0.1 0.1 0.1 1.0"/>
      </material>
    </visual>
  </link>

  <!-- Joint: Camera Tilt → Camera (fixed) -->
  <joint name="camera_optical_joint" type="fixed">
    <parent link="camera_tilt"/>
    <child link="camera_link"/>
    <origin xyz="0.04 0 0" rpy="0 0 0"/>  <!-- Camera faces forward from tilt mount -->
  </joint>

  <!-- Camera Sensor -->
  <gazebo reference="camera_link">
    <sensor name="satellite_camera" type="camera">
      <pose>0 0 0 0 0 0</pose>  <!-- Camera faces in +X direction of camera_link -->
      <camera>
        <horizontal_fov>1.5708</horizontal_fov>  <!-- 90 degrees FOV -->
        <image>
          <width>640</width>
          <height>480</height>
          <format>R8G8B8</format>
        </image>
        <clip>
          <near>0.1</near>
          <far>10000</far>  <!-- Can see very far to capture Earth -->
        </clip>
        <noise>
          <type>gaussian</type>
          <mean>0.0</mean>
          <stddev>0.007</stddev>
        </noise>
      </camera>
      <always_on>1</always_on>
      <update_rate>10</update_rate>
      <visualize>true</visualize>
      <topic>satellite_camera</topic>
    </sensor>
  </gazebo>

  <!-- Gazebo Plugins for Camera Control -->
  <gazebo>
    <plugin filename="gz-sim-joint-position-controller-system"
            name="gz::sim::systems::JointPositionController">
      <joint_name>camera_azimuth_joint</joint_name>
      <topic>camera/azimuth_cmd</topic>
      <p_gain>50</p_gain>
      <i_gain>5</i_gain>
      <d_gain>2</d_gain>
      <i_max>5</i_max>
      <i_min>-5</i_min>
      <cmd_max>6.28319</cmd_max>
      <cmd_min>-6.28319</cmd_min>
    </plugin>
  </gazebo>

  <gazebo>
    <plugin filename="gz-sim-joint-position-controller-system"
            name="gz::sim::systems::JointPositionController">
      <joint_name>camera_elevation_joint</joint_name>
      <topic>camera/elevation_cmd</topic>
      <p_gain>50</p_gain>
      <i_gain>5</i_gain>
      <d_gain>2</d_gain>
      <i_max>5</i_max>
      <i_min>-5</i_min>
      <cmd_max>3.14159</cmd_max>
      <cmd_min>-3.14159</cmd_min>
    </plugin>
  </gazebo>

  <!-- ================= FR3 ROBOT ================= -->

  <joint name="satellite_to_franka" type="fixed">
    <origin xyz="0 0 0.75" rpy="0 0 0"/>
    <parent link="satellite_base"/>
    <child link="fr3_link0"/>
  </joint>

  <!-- ✅ ROS 2 SAFE YAML LOADS -->
  <xacro:franka_robot
    arm_id="fr3"
    joint_limits="${xacro.load_yaml('$(find franka_description)/robots/fr3/joint_limits.yaml')}"
    inertials="${xacro.load_yaml('$(find franka_description)/robots/fr3/inertials.yaml')}"
    kinematics="${xacro.load_yaml('$(find franka_description)/robots/fr3/kinematics.yaml')}"
    accelerometer_config="${xacro.load_yaml('$(find franka_description)/robots/fr3/accelerometers.yaml')}"
    dynamics="${xacro.load_yaml('$(find franka_description)/robots/fr3/dynamics.yaml')}"

    hand="${load_gripper}"
    ee_id="${ee_id}"
    connected_to=""
  />

  <!-- ================= GAZEBO PLUGINS FOR CONTROL ================= -->
  
  <!-- Odometry Publisher for Satellite -->
  <gazebo>
    <plugin name="odometry_publisher" filename="gz-sim-odometry-publisher-system">
      <dimensions>3</dimensions>
      <odom_publish_frequency>50.0</odom_publish_frequency>
      <odom_frame>world</odom_frame>
      <robot_base_frame>satellite_base</robot_base_frame>
    </plugin>
  </gazebo>

  <!-- Joint Position Controllers for FR3 Arm -->
  <gazebo>
    <plugin filename="gz-sim-joint-position-controller-system"
            name="gz::sim::systems::JointPositionController">
      <joint_name>fr3_joint1</joint_name>
      <topic>fr3/joint1_cmd</topic>
      <p_gain>100</p_gain>
      <i_gain>10</i_gain>
      <d_gain>5</d_gain>
      <i_max>10</i_max>
      <i_min>-10</i_min>
      <cmd_max>2.8973</cmd_max>
      <cmd_min>-2.8973</cmd_min>
    </plugin>
  </gazebo>

  <gazebo>
    <plugin filename="gz-sim-joint-position-controller-system"
            name="gz::sim::systems::JointPositionController">
      <joint_name>fr3_joint2</joint_name>
      <topic>fr3/joint2_cmd</topic>
      <p_gain>100</p_gain>
      <i_gain>10</i_gain>
      <d_gain>5</d_gain>
      <i_max>10</i_max>
      <i_min>-10</i_min>
      <cmd_max>1.7628</cmd_max>
      <cmd_min>-1.7628</cmd_min>
    </plugin>
  </gazebo>

  <gazebo>
    <plugin filename="gz-sim-joint-position-controller-system"
            name="gz::sim::systems::JointPositionController">
      <joint_name>fr3_joint3</joint_name>
      <topic>fr3/joint3_cmd</topic>
      <p_gain>100</p_gain>
      <i_gain>10</i_gain>
      <d_gain>5</d_gain>
      <i_max>10</i_max>
      <i_min>-10</i_min>
      <cmd_max>2.8973</cmd_max>
      <cmd_min>-2.8973</cmd_min>
    </plugin>
  </gazebo>

  <gazebo>
    <plugin filename="gz-sim-joint-position-controller-system"
            name="gz::sim::systems::JointPositionController">
      <joint_name>fr3_joint4</joint_name>
      <topic>fr3/joint4_cmd</topic>
      <p_gain>100</p_gain>
      <i_gain>10</i_gain>
      <d_gain>5</d_gain>
      <i_max>10</i_max>
      <i_min>-10</i_min>
      <cmd_max>-0.0698</cmd_max>
      <cmd_min>-3.0718</cmd_min>
    </plugin>
  </gazebo>

  <gazebo>
    <plugin filename="gz-sim-joint-position-controller-system"
            name="gz::sim::systems::JointPositionController">
      <joint_name>fr3_joint5</joint_name>
      <topic>fr3/joint5_cmd</topic>
      <p_gain>100</p_gain>
      <i_gain>10</i_gain>
      <d_gain>5</d_gain>
      <i_max>10</i_max>
      <i_min>-10</i_min>
      <cmd_max>2.8973</cmd_max>
      <cmd_min>-2.8973</cmd_min>
    </plugin>
  </gazebo>

  <gazebo>
    <plugin filename="gz-sim-joint-position-controller-system"
            name="gz::sim::systems::JointPositionController">
      <joint_name>fr3_joint6</joint_name>
      <topic>fr3/joint6_cmd</topic>
      <p_gain>100</p_gain>
      <i_gain>10</i_gain>
      <d_gain>5</d_gain>
      <i_max>10</i_max>
      <i_min>-10</i_min>
      <cmd_max>3.7525</cmd_max>
      <cmd_min>-0.0175</cmd_min>
    </plugin>
  </gazebo>

  <gazebo>
    <plugin filename="gz-sim-joint-position-controller-system"
            name="gz::sim::systems::JointPositionController">
      <joint_name>fr3_joint7</joint_name>
      <topic>fr3/joint7_cmd</topic>
      <p_gain>100</p_gain>
      <i_gain>10</i_gain>
      <d_gain>5</d_gain>
      <i_max>10</i_max>
      <i_min>-10</i_min>
      <cmd_max>2.8973</cmd_max>
      <cmd_min>-2.8973</cmd_min>
    </plugin>
  </gazebo>

  <!-- Gripper Controllers -->
  <gazebo>
    <plugin filename="gz-sim-joint-position-controller-system"
            name="gz::sim::systems::JointPositionController">
      <joint_name>fr3_finger_joint1</joint_name>
      <topic>fr3/gripper_cmd</topic>
      <p_gain>50</p_gain>
      <i_gain>5</i_gain>
      <d_gain>1</d_gain>
      <i_max>5</i_max>
      <i_min>-5</i_min>
      <cmd_max>0.04</cmd_max>
      <cmd_min>0.0</cmd_min>
    </plugin>
  </gazebo>

  <!-- Thrusters for orbital adjustments -->
  <link name="forward_thruster">
    <inertial>
      <mass value="0.01"/>
      <origin xyz="0 0 0"/>
      <inertia
        ixx="0.0001" ixy="0" ixz="0"
        iyy="0.0001" iyz="0"
        izz="0.0001"/>
    </inertial>
  </link>

  <joint name="forward_thruster_joint" type="revolute">
    <parent link="satellite_base"/>
    <child link="forward_thruster"/>
    <origin xyz="0 0 0"/>
    <axis xyz="1 0 0"/>
    <limit lower="-1e16" upper="1e16" effort="1000" velocity="1000"/>
  </joint>

  <link name="lateral_thruster">
    <inertial>
      <mass value="0.01"/>
      <origin xyz="0 0 0"/>
      <inertia
        ixx="0.0001" ixy="0" ixz="0"
        iyy="0.0001" iyz="0"
        izz="0.0001"/>
    </inertial>
  </link>

  <joint name="lateral_thruster_joint" type="revolute">
    <parent link="satellite_base"/>
    <child link="lateral_thruster"/>
    <origin xyz="0 0 0"/>
    <axis xyz="0 1 0"/>
    <limit lower="-1e16" upper="1e16" effort="1000" velocity="1000"/>
  </joint>

  <link name="vertical_thruster">
    <inertial>
      <mass value="0.01"/>
      <origin xyz="0 0 0"/>
      <inertia
        ixx="0.0001" ixy="0" ixz="0"
        iyy="0.0001" iyz="0"
        izz="0.0001"/>
    </inertial>
  </link>

  <joint name="vertical_thruster_joint" type="revolute">
    <parent link="satellite_base"/>
    <child link="vertical_thruster"/>
    <origin xyz="0 0 0"/>
    <axis xyz="0 0 1"/>
    <limit lower="-1e16" upper="1e16" effort="1000" velocity="1000"/>
  </joint>

  <!-- Thruster Plugins -->
  <gazebo>
    <plugin filename="gz-sim-thruster-system"
            name="gz::sim::systems::Thruster">
      <joint_name>forward_thruster_joint</joint_name>
      <thrust_coefficient>0.01</thrust_coefficient>
      <fluid_density>1.0</fluid_density>
      <propeller_diameter>0.5</propeller_diameter>
      <max_thrust_cmd>100</max_thrust_cmd>
      <min_thrust_cmd>-100</min_thrust_cmd>
    </plugin>
  </gazebo>

  <gazebo>
    <plugin filename="gz-sim-thruster-system"
            name="gz::sim::systems::Thruster">
      <joint_name>lateral_thruster_joint</joint_name>
      <thrust_coefficient>0.01</thrust_coefficient>
      <fluid_density>1.0</fluid_density>
      <propeller_diameter>0.5</propeller_diameter>
      <max_thrust_cmd>100</max_thrust_cmd>
      <min_thrust_cmd>-100</min_thrust_cmd>
    </plugin>
  </gazebo>

  <gazebo>
    <plugin filename="gz-sim-thruster-system"
            name="gz::sim::systems::Thruster">
      <joint_name>vertical_thruster_joint</joint_name>
      <thrust_coefficient>0.01</thrust_coefficient>
      <fluid_density>1.0</fluid_density>
      <propeller_diameter>0.5</propeller_diameter>
      <max_thrust_cmd>100</max_thrust_cmd>
      <min_thrust_cmd>-100</min_thrust_cmd>
    </plugin>
  </gazebo>

</robot>
